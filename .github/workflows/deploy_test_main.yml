name: Deploy Test on PR

on: pull_request

    
jobs:
  deploy:
    runs-on: ubuntu-18.04
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Deploy
        run: |
          cd ${{ github.workspace }}
          ls -la ${{ github.workspace }}
          ls ${{ github.workspace }}/scripts
          sh ${{ github.workspace }}/scripts/start_deploy.sh ${GITHUB_REF##*/}
      - name: Build docker
        run: docker-compose build --build-arg RUNMODE=test
      - name: Run docker
        run: docker-compose up -d
      - name: Check service port 
        run: nc -vz localhost 5000
      - name: Run tests
        run: curl http://127.0.0.1:80
